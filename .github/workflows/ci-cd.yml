name: OpenAdmin CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ created ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java-version: [ 25 ]
        distribution: [ 'temurin' ]
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Java ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: ${{ matrix.distribution }}
        cache: 'maven'
        
    - name: Setup Maven
      uses: stCarolas/setup-maven@v5
      with:
        maven-version: 3.9.6
        
    - name: Cache Maven Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
          
    - name: Validate Maven Wrapper
      run: |
        chmod +x ./mvnw
        ./mvnw --version
        
    - name: Run Maven Build
      run: |
        ./mvnw clean install -DskipTests
        
    - name: Run Unit Tests
      run: |
        ./mvnw test
        
    - name: Run Integration Tests
      run: |
        ./mvnw verify -DskipUTs=true
        
    - name: Generate Coverage Report
      run: |
        ./mvnw jacoco:report
        
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./target/site/jacoco/jacoco.xml
        flags: unittests
        name: codecov-umbrella
        
    - name: Archive Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          **/target/surefire-reports/
          **/target/failsafe-reports/
          **/target/site/jacoco/
          
  quality-check:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Java 25
      uses: actions/setup-java@v4
      with:
        java-version: 25
        distribution: 'temurin'
        
    - name: Run Code Quality Checks
      run: |
        ./mvnw checkstyle:check pmd:check spotbugs:check
        
    - name: Run Security Scan
      run: |
        ./mvnw dependency-check:check
        
    - name: Run License Check
      run: |
        ./mvnw apache-rat:check
        
    - name: Archive Quality Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: quality-reports
        path: |
          **/target/checkstyle-result.xml
          **/target/pmd.xml
          **/target/spotbugsXml.xml
          **/target/dependency-check-report.html
          **/target/rat.txt
          
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [build, quality-check]
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Java 25
      uses: actions/setup-java@v4
      with:
        java-version: 25
        distribution: 'temurin'
        
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: test-results
        path: target
      
    - name: SonarQube Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      run: |
        ./mvnw sonar:sonar \
          -Dsonar.projectKey=com.qoobot:openadmin \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
          
  docker-build:
    name: Docker Image Build
    runs-on: ubuntu-latest
    needs: [build, quality-check]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: qoobot/openadmin
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=sha,prefix=
          
    - name: Build and Push Docker Images
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
  deploy:
    name: Deploy to Maven Central
    runs-on: ubuntu-latest
    needs: [build, quality-check]
    if: github.event_name == 'release' && github.event.action == 'created'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Setup Java 25
      uses: actions/setup-java@v4
      with:
        java-version: 25
        distribution: 'temurin'
        server-id: ossrh
        server-username: OSSRH_USERNAME
        server-password: OSSRH_PASSWORD
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
        gpg-passphrase: GPG_PASSPHRASE
        
    - name: Publish to Maven Central
      env:
        OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
        OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
        GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        ./mvnw clean deploy -P release