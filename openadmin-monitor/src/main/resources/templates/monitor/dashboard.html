<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统监控面板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .alert-high { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .alert-medium { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .alert-low { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-primary">系统监控面板</h1>
                <p class="text-muted">实时监控系统状态和性能指标</p>
            </div>
        </div>

        <!-- 系统概览卡片 -->
        <div class="row mb-4" id="overviewCards">
            <div class="col-md-3 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">系统状态</h5>
                        <h2 id="systemStatus" class="text-success">健康</h2>
                        <p class="card-text">最后更新: <span id="lastUpdate">-</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">内存使用率</h5>
                        <h2 id="memoryUsage" class="text-info">0%</h2>
                        <div class="progress mt-2">
                            <div id="memoryProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">线程数</h5>
                        <h2 id="threadCount" class="text-warning">0</h2>
                        <p class="card-text">峰值: <span id="peakThreadCount">0</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">错误率</h5>
                        <h2 id="errorRate" class="text-danger">0%</h2>
                        <p class="card-text">错误日志: <span id="errorCount">0</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>性能趋势</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5>资源使用</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="resourceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细指标表格 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>详细监控指标</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshData()">刷新数据</button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>指标名称</th>
                                        <th>当前值</th>
                                        <th>状态</th>
                                        <th>描述</th>
                                    </tr>
                                </thead>
                                <tbody id="metricsTableBody">
                                    <!-- 动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 告警面板 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>系统告警</h5>
                    </div>
                    <div class="card-body" id="alertPanel">
                        <div class="alert alert-low" role="alert">
                            <strong>系统正常运行</strong> - 当前无告警
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let performanceChart, resourceChart;
        let metricsData = [];
        let refreshInterval;

        // 初始化图表
        function initCharts() {
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '响应时间(ms)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const resourceCtx = document.getElementById('resourceChart').getContext('2d');
            resourceChart = new Chart(resourceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['已用内存', '可用内存'],
                    datasets: [{
                        data: [0, 100],
                        backgroundColor: ['rgb(255, 99, 132)', 'rgb(54, 162, 235)']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // 刷新数据
        async function refreshData() {
            try {
                // 获取系统健康状态
                const healthResponse = await fetch('/api/monitor/health');
                const healthData = await healthResponse.json();
                
                if (healthData.success) {
                    updateOverview(healthData.data);
                }

                // 获取JVM指标
                const jvmResponse = await fetch('/api/monitor/metrics/jvm');
                const jvmData = await jvmResponse.json();
                
                if (jvmData.success) {
                    updateJvmMetrics(jvmData.data);
                }

                // 获取日志统计
                const logResponse = await fetch('/api/monitor/logs/statistics');
                const logData = await logResponse.json();
                
                if (logData.success) {
                    updateLogMetrics(logData.data);
                }

                // 检查告警
                const alertResponse = await fetch('/api/monitor/alerts/check');
                const alertData = await alertResponse.json();
                
                if (alertData.success) {
                    updateAlerts(alertData.data);
                }

                // 更新时间戳
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('刷新数据失败:', error);
            }
        }

        // 更新概览信息
        function updateOverview(data) {
            const memoryUsage = (data.heapMemoryUsed / data.heapMemoryMax * 100).toFixed(1);
            document.getElementById('memoryUsage').textContent = memoryUsage + '%';
            document.getElementById('memoryProgressBar').style.width = memoryUsage + '%';
            document.getElementById('threadCount').textContent = data.threadCount;
            document.getElementById('peakThreadCount').textContent = data.peakThreadCount;
        }

        // 更新JVM指标
        function updateJvmMetrics(data) {
            const metrics = [
                {name: '堆内存使用', value: formatBytes(data.heapMemoryUsed), status: 'normal'},
                {name: '最大堆内存', value: formatBytes(data.heapMemoryMax), status: 'info'},
                {name: '线程总数', value: data.threadCount, status: 'normal'},
                {name: 'GC收集次数', value: data.gcCollectionCount, status: 'warning'}
            ];
            
            updateMetricsTable(metrics);
        }

        // 更新日志指标
        function updateLogMetrics(data) {
            const errorRate = (data.errorRate * 100).toFixed(2);
            document.getElementById('errorRate').textContent = errorRate + '%';
            document.getElementById('errorCount').textContent = data.totalErrorLogs;
        }

        // 更新告警信息
        function updateAlerts(data) {
            const alertPanel = document.getElementById('alertPanel');
            alertPanel.innerHTML = '';
            
            if (data.shouldAlert) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-high';
                alertDiv.innerHTML = `<strong>告警!</strong> ${data.alertReason} - 错误数: ${data.errorCount}, 警告数: ${data.warnCount}`;
                alertPanel.appendChild(alertDiv);
            } else {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-low';
                alertDiv.innerHTML = '<strong>系统正常</strong> - 当前无告警';
                alertPanel.appendChild(alertDiv);
            }
        }

        // 更新指标表格
        function updateMetricsTable(metrics) {
            const tbody = document.getElementById('metricsTableBody');
            tbody.innerHTML = '';
            
            metrics.forEach(metric => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${metric.name}</td>
                    <td>${metric.value}</td>
                    <td><span class="badge bg-${getStatusColor(metric.status)}">${getStatusText(metric.status)}</span></td>
                    <td>-</td>
                `;
                tbody.appendChild(row);
            });
        }

        // 辅助函数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getStatusColor(status) {
            const colors = {
                'normal': 'success',
                'info': 'info',
                'warning': 'warning',
                'danger': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'normal': '正常',
                'info': '信息',
                'warning': '警告',
                'danger': '危险'
            };
            return texts[status] || '未知';
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshData();
            
            // 每30秒自动刷新
            refreshInterval = setInterval(refreshData, 30000);
        });

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>