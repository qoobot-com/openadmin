<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAdmin 网关管理平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
        }
        
        body {
            background-color: #f8f9fa;
        }
        
        .sidebar {
            background: linear-gradient(180deg, #0d6efd 0%, #0b5ed7 100%);
            color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            border-radius: 5px;
            margin: 5px 10px;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);
            color: white;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #146c43 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #e0a800 100%);
            color: #212529;
        }
        
        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #bb2d3b 100%);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            display: block;
        }
        
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }
        
        .badge-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .status-active {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-md-2 sidebar p-0">
                <div class="p-4">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-shield-lock"></i> 网关管理
                    </h4>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                                <i class="bi bi-speedometer2 me-2"></i>仪表盘
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#routes" data-bs-toggle="tab">
                                <i class="bi bi-diagram-3 me-2"></i>路由管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#auth" data-bs-toggle="tab">
                                <i class="bi bi-person-check me-2"></i>认证管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#ratelimit" data-bs-toggle="tab">
                                <i class="bi bi-speedometer me-2"></i>限流管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#monitoring" data-bs-toggle="tab">
                                <i class="bi bi-bar-chart me-2"></i>监控统计
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#settings" data-bs-toggle="tab">
                                <i class="bi bi-gear me-2"></i>系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="col-md-10 p-4">
                <div class="tab-content">
                    <!-- 仪表盘 -->
                    <div class="tab-pane fade show active" id="dashboard">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-speedometer2 me-2"></i>网关仪表盘</h2>
                            <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                                <i class="bi bi-arrow-clockwise me-1"></i>刷新
                            </button>
                        </div>

                        <!-- 统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card stat-card">
                                    <div class="card-body text-center">
                                        <span class="metric-value" id="routeCount">0</span>
                                        <span class="metric-label">路由数量</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card success">
                                    <div class="card-body text-center">
                                        <span class="metric-value" id="blacklistSize">0</span>
                                        <span class="metric-label">黑名单数量</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card warning">
                                    <div class="card-body text-center">
                                        <span class="metric-value" id="activeConnections">0</span>
                                        <span class="metric-label">活跃连接</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stat-card danger">
                                    <div class="card-body text-center">
                                        <span class="metric-value" id="errorRate">0%</span>
                                        <span class="metric-label">错误率</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 状态概览 -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-hdd-network me-2"></i>系统状态</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>认证服务</span>
                                            <span class="badge bg-success">运行中</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>限流服务</span>
                                            <span class="badge bg-success">运行中</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>熔断器</span>
                                            <span class="badge bg-success">运行中</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>负载均衡</span>
                                            <span class="badge bg-success">运行中</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>性能指标</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>平均响应时间</span>
                                            <span id="avgResponseTime">12ms</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>QPS</span>
                                            <span id="currentQps">1,234</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>内存使用</span>
                                            <span id="memoryUsage">45%</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>CPU使用</span>
                                            <span id="cpuUsage">23%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 路由管理 -->
                    <div class="tab-pane fade" id="routes">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-diagram-3 me-2"></i>路由管理</h2>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRouteModal">
                                <i class="bi bi-plus-lg me-1"></i>添加路由
                            </button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>路径</th>
                                                <th>目标URI</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="routesTableBody">
                                            <!-- 动态加载路由数据 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 认证管理 -->
                    <div class="tab-pane fade" id="auth">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2><i class="bi bi-person-check me-2"></i>认证管理</h2>
                            <button class="btn btn-danger" onclick="clearBlacklist()">
                                <i class="bi bi-trash me-1"></i>清空黑名单
                            </button>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">添加到黑名单</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Token</label>
                                            <textarea class="form-control" id="blacklistToken" rows="3" placeholder="输入要加入黑名单的Token"></textarea>
                                        </div>
                                        <button class="btn btn-primary" onclick="addToBlacklist()">添加到黑名单</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">黑名单统计</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>黑名单总数</span>
                                            <span class="fw-bold" id="blacklistCount">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>最近更新</span>
                                            <span id="lastBlacklistUpdate">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 限流管理 -->
                    <div class="tab-pane fade" id="ratelimit">
                        <h2><i class="bi bi-speedometer me-2"></i>限流管理</h2>
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">全局限流</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">每秒请求数</label>
                                            <input type="number" class="form-control" id="globalPermits" value="1000">
                                        </div>
                                        <button class="btn btn-primary" onclick="updateGlobalRateLimit()">更新</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">IP限流</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">每分钟请求数</label>
                                            <input type="number" class="form-control" id="ipPermits" value="100">
                                        </div>
                                        <button class="btn btn-primary" onclick="updateIpRateLimit()">更新</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">用户限流</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">每分钟请求数</label>
                                            <input type="number" class="form-control" id="userPermits" value="200">
                                        </div>
                                        <button class="btn btn-primary" onclick="updateUserRateLimit()">更新</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 监控统计 -->
                    <div class="tab-pane fade" id="monitoring">
                        <h2><i class="bi bi-bar-chart me-2"></i>监控统计</h2>
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">实时监控</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="chart-container">
                                            <canvas id="monitoringChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统设置 -->
                    <div class="tab-pane fade" id="settings">
                        <h2><i class="bi bi-gear me-2"></i>系统设置</h2>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">基础配置</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">JWT密钥</label>
                                            <input type="password" class="form-control" id="jwtSecret">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Token过期时间(秒)</label>
                                            <input type="number" class="form-control" id="tokenExpireTime" value="3600">
                                        </div>
                                        <button class="btn btn-primary">保存配置</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加路由模态框 -->
    <div class="modal fade" id="addRouteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加新路由</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">路由ID</label>
                        <input type="text" class="form-control" id="routeId">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">路径匹配</label>
                        <input type="text" class="form-control" id="routePath" placeholder="/api/**">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">目标URI</label>
                        <input type="text" class="form-control" id="routeUri" placeholder="lb://service-name">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addNewRoute()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            loadRoutesData();
            loadAuthStats();
        });

        // 刷新仪表盘
        function refreshDashboard() {
            loadDashboardData();
            loadRoutesData();
            loadAuthStats();
        }

        // 加载仪表盘数据
        function loadDashboardData() {
            fetch('/gateway/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('routeCount').textContent = data.routeCount || 0;
                    document.getElementById('blacklistSize').textContent = data.blacklistSize || 0;
                })
                .catch(error => console.error('Error loading dashboard data:', error));
        }

        // 加载路由数据
        function loadRoutesData() {
            fetch('/gateway/routes')
                .then(response => response.json())
                .then(routes => {
                    const tbody = document.getElementById('routesTableBody');
                    tbody.innerHTML = '';
                    
                    routes.forEach(route => {
                        const row = `
                            <tr>
                                <td>${route.id}</td>
                                <td>${route.predicates?.[0]?.args?.patterns?.[0] || '-'}</td>
                                <td>${route.uri}</td>
                                <td><span class="badge bg-success">启用</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger btn-icon" onclick="deleteRoute('${route.id}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => console.error('Error loading routes:', error));
        }

        // 加载认证统计
        function loadAuthStats() {
            fetch('/gateway/auth/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('blacklistCount').textContent = data.blacklistSize || 0;
                    document.getElementById('lastBlacklistUpdate').textContent = new Date().toLocaleTimeString();
                })
                .catch(error => console.error('Error loading auth stats:', error));
        }

        // 添加到黑名单
        function addToBlacklist() {
            const token = document.getElementById('blacklistToken').value;
            if (!token) {
                alert('请输入Token');
                return;
            }

            fetch('/gateway/auth/blacklist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token: token })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Token已添加到黑名单');
                    document.getElementById('blacklistToken').value = '';
                    loadAuthStats();
                } else {
                    alert('添加失败: ' + data.error);
                }
            })
            .catch(error => {
                alert('请求失败: ' + error.message);
            });
        }

        // 清空黑名单
        function clearBlacklist() {
            if (confirm('确定要清空所有黑名单吗？')) {
                fetch('/gateway/auth/blacklist', {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('黑名单已清空');
                        loadAuthStats();
                    }
                })
                .catch(error => alert('操作失败'));
            }
        }

        // 添加新路由
        function addNewRoute() {
            const routeData = {
                id: document.getElementById('routeId').value,
                path: document.getElementById('routePath').value,
                uri: document.getElementById('routeUri').value
            };

            fetch('/gateway/routes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(routeData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('路由添加成功');
                    bootstrap.Modal.getInstance(document.getElementById('addRouteModal')).hide();
                    loadRoutesData();
                } else {
                    alert('添加失败: ' + data.error);
                }
            })
            .catch(error => alert('请求失败'));
        }

        // 删除路由
        function deleteRoute(routeId) {
            if (confirm('确定要删除此路由吗？')) {
                fetch(`/gateway/routes/${routeId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('路由删除成功');
                        loadRoutesData();
                    } else {
                        alert('删除失败: ' + data.error);
                    }
                })
                .catch(error => alert('操作失败'));
            }
        }

        // 更新各种限流配置的函数
        function updateGlobalRateLimit() { /* 实现逻辑 */ }
        function updateIpRateLimit() { /* 实现逻辑 */ }
        function updateUserRateLimit() { /* 实现逻辑 */ }
    </script>
</body>
</html>